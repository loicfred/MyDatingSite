<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>Edit Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .interest-tag, .language-tag {
      display: inline-block;
      padding: 5px 10px;
      margin: 3px;
      background-color: #eee;
      border-radius: 15px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }
    .interest-tag.selected, .language-tag.selected {
      background-color: #007bff;
      color: white;
    }

  </style>
</head>
<body class="bg-light">

<div th:replace="/fragments/header :: mainHeader"></div>

<div class="container mt-3">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10">
        <form th:action="@{/post/profile/edit}" th:object="${profile}" method="post" enctype="multipart/form-data">
          <input type="hidden" th:field="*{ID}" />

          <div th:if="${profile.NullFields > 0}" class="alert alert-danger">
             Your profile isn't complete yet. Please complete your profile to start finding partners.
          </div>

          <div class="accordion" id="profileAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingPersonal">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePersonal">Essential Details</button>
              </h2>
              <div id="collapsePersonal" class="accordion-collapse collapse show" data-bs-parent="#profileAccordion">
                <div class="accordion-body">
                  <!-- Avatar -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Profile Picture</label>
                    <div class="d-flex align-items-center gap-3">
                      <img th:src="${profile.Avatar != null ? '/file/avatar/' + profile.Username + '.png' : '/img/default-pfp.png'}"
                           class="rounded-circle border"
                           style="width:100px;height:100px;object-fit:cover;transition: transform .2s;"
                           onmouseover="this.style.transform='scale(1.1)'"
                           onmouseout="this.style.transform='scale(1)'"/>
                      <input type="file" name="profilePicFile" class="form-control"/>
                    </div>
                  </div>

                  <!-- Name -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Name</label>
                    <input type="text" th:field="*{Name}" class="form-control" placeholder="What's your name?">
                  </div>

                  <!-- WhoAmI -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Who are you?</label>
                    <textarea th:field="*{WhoAmI}" class="form-control" rows="2" placeholder="Tell us something about yourself..."></textarea>
                  </div>

                  <!-- WhatIWant -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">What are you looking for?</label>
                    <textarea th:field="*{WhatIWant}" class="form-control" rows="2" placeholder="Tell us what kind of partner are you looking for..."></textarea>
                  </div>

                  <!-- WhatIDislike -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">What do you not want to find?</label>
                    <textarea th:field="*{WhatIDislike}" class="form-control" rows="2" placeholder="Tell us what kind of partner you wouldn't want to find..."></textarea>
                  </div>

                  <!-- Gender -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Gender</label>
                    <select th:field="*{Gender}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="opt : ${T(my.dating.app.object.enums.Gender).values()}"
                              th:value="${opt}" th:text="${opt.displayName}">
                      </option>
                    </select>
                  </div>

                  <!-- Date of Birth -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Date of Birth</label>
                    <input type="date" th:field="*{DateOfBirth}" class="form-control"/>
                  </div>

                  <!-- Interest -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Interests</label>
                    <div id="interests-container">
                      <span th:each="interest : ${T(my.dating.app.object.enums.Interest).values()}"
                            th:data-value="${interest}" th:text="${interest.displayName}"
                            class="interest-tag"></span>
                    </div>
                    <div id="interests-selected-inputs">
                      <input type="hidden" th:each="i : *{interests}" name="interests" th:value="${i}" />
                    </div>
                  </div>

                  <!-- Languages -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Languages</label>
                    <div id="languages-container">
                      <span th:each="language : ${T(my.dating.app.object.enums.Language).values()}"
                            th:data-value="${language}"
                            th:text="${language.displayName}"
                            class="language-tag"></span>
                    </div>
                    <div id="languages-selected-inputs">
                      <input type="hidden" th:each="i : *{languages}" name="languages" th:value="${i}" />
                    </div>
                  </div>

                  <!-- Personality -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">How is your personality?</label>
                    <select th:field="*{PersonalityType}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="pt : ${T(my.dating.app.object.enums.PersonalityType).values()}"
                              th:value="${pt}" th:text="${pt.displayName}"></option>
                    </select>
                  </div>

                  <!-- Button -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Location (Warning: Never use your exact location, but an area surrounding.)</label>
                    <div class="input-group">
                      <input type="text" th:field="*{Latitude}" id="latitude" class="form-control" placeholder="Latitude" readonly>
                      <input type="text" th:field="*{Longitude}" id="longitude" class="form-control" placeholder="Longitude" readonly>
                      <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#mapModal">
                        Pick on Map
                      </button>
                    </div>
                  </div>

                  <!-- Modal -->
                  <div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                      <div class="modal-content">
                        <div class="modal-header">
                          <h5 class="modal-title">Select Location</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" style="height: 500px;">
                          <div id="map" style="height: 100%;"></div>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>

            <div class="accordion-item">
              <h2 class="accordion-header" id="headingLifestyle">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseLifestyle">Lifestyle</button>
              </h2>
              <div id="collapseLifestyle" class="accordion-collapse collapse show" data-bs-parent="#profileAccordion">
                <div class="accordion-body">
                  <!-- Education -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">What studies did you do?</label>
                    <input type="text" th:field="*{Education}" class="form-control" placeholder="How far you went in your studies?"/>
                  </div>

                  <!-- Occupation -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Do you have a job? What is it?</label>
                    <input type="text" th:field="*{Occupation}" class="form-control" placeholder="Your job or profession"/>
                  </div>

                  <!-- Religion -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">What is your religion?</label>
                    <select th:field="*{Religion}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="r : ${T(my.dating.app.object.enums.Religion).values()}"
                              th:value="${r}" th:text="${r.displayName}"></option>
                    </select>
                  </div>

                  <!-- Diet -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">What are your diet habits?</label>
                    <select th:field="*{Diet}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="d : ${T(my.dating.app.object.enums.Diet).values()}"
                              th:value="${d}" th:text="${d.displayName}"></option>
                    </select>
                  </div>

                  <!-- Cooking -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Would you cook for your partner if you are able to?</label>
                    <select th:field="*{WouldCook}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="opt : ${T(my.dating.app.object.enums.LifestylePreference).values()}"
                              th:value="${opt}" th:text="${opt.displayName}">
                      </option>
                    </select>
                  </div>

                  <!-- Chores -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Would you take care of the household chores if you are able to?</label>
                    <select th:field="*{WouldChore}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="opt : ${T(my.dating.app.object.enums.LifestylePreference).values()}"
                              th:value="${opt}" th:text="${opt.displayName}">
                      </option>
                    </select>
                  </div>

                  <!-- Smoking -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Do you smoke?</label>
                    <select th:field="*{StatusSmoking}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="opt : ${T(my.dating.app.object.enums.BadHabit).values()}"
                              th:value="${opt}" th:text="${opt.displayName}">
                      </option>
                    </select>
                  </div>

                  <!-- Drinking -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Do you drink alcohol?</label>
                        <select th:field="*{StatusDrinking}" class="form-select">
                            <option value="">Choose an option</option>
                            <option th:each="opt : ${T(my.dating.app.object.enums.BadHabit).values()}"
                                    th:value="${opt}" th:text="${opt.displayName}">
                            </option>
                        </select>
                    </div>

                  <!-- Exercise -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Do you exercise?</label>
                    <select th:field="*{StatusExercise}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="opt : ${T(my.dating.app.object.enums.BadHabit).values()}"
                              th:value="${opt}" th:text="${opt.displayName}">
                      </option>
                    </select>
                  </div>

                  <!-- Illness -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Do you have any allergies or illness?</label>
                    <input type="text" th:field="*{Allergies}" class="form-control" placeholder="Tell us about your allergies or illnesses."/>
                  </div>

                  <!-- Disability -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Do you have any disabilities?</label>
                    <input type="text" th:field="*{Disability}" class="form-control" placeholder="Tell us about your disabilities."/>
                  </div>

                  <!-- Pets -->
                  <div class="mb-3">
                    <input type="checkbox" th:field="*{LikePets}" /> Do you like pets?
                  </div>

                </div>
              </div>
            </div>
              <div class="accordion-item">
                  <h2 class="accordion-header" id="headingContact">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseContact">Messenging</button>
                  </h2>
                  <div id="collapseContact" class="accordion-collapse collapse show" data-bs-parent="#profileAccordion">
                      <div class="accordion-body">

                          <!-- Rapidity -->
                          <div class="mb-3">
                              <input type="checkbox" th:field="*{MessageRead}" /> Do you often leave people on 'read'?
                          </div>

                          <!-- Rapidity -->
                          <div class="mb-3">
                              <label class="form-label fw-semibold">How fast do you answer messages?</label>
                              <select th:field="*{MessageReplySpeed}" class="form-select">
                                  <option value="">Choose an option</option>
                                  <option th:each="opt : ${T(my.dating.app.object.enums.Rapidity).values()}"
                                          th:value="${opt}" th:text="${opt.displayName}">
                                  </option>
                              </select>
                          </div>

                      </div>
                  </div>
              </div>

            <div class="accordion-item">
              <h2 class="accordion-header" id="headingFamily">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFamily">Family & Couple</button>
              </h2>
              <div id="collapseFamily" class="accordion-collapse collapse show" data-bs-parent="#profileAccordion">
                <div class="accordion-body">

                  <!-- Previous Relationship -->
                  <div class="mb-3">
                    How many previous partners do you have? <input type="number" th:field="*{PastPartners}"/>
                  </div>

                  <!-- Virginity -->
                  <div class="mb-3">
                    <input type="checkbox" th:field="*{Virgin}"/> Are you a virgin?
                  </div>

                  <!-- Marriage -->
                  <div class="mb-3">
                    <input type="checkbox" th:field="*{WantMarriage}" /> Are you looking for a partner to marry?
                  </div>

                  <!-- Religion matter -->
                  <div class="mb-3">
                    <input type="checkbox" th:field="*{ReligionMatter}" /> If yes, must your partner be of same religion as you?
                  </div>

                  <!-- Children -->
                  <div class="mb-3">
                    <label class="form-label fw-semibold">Do you plan to have kids?</label>
                    <select th:field="*{WantKids}" class="form-select">
                      <option value="">Choose an option</option>
                      <option th:each="opt : ${T(my.dating.app.object.enums.KidsPreference).values()}"
                              th:value="${opt}" th:text="${opt.displayName}">
                    </select>
                  </div>

                  <!-- Already have children -->
                  <div class="mb-3">
                    <input type="checkbox" th:field="*{AlreadyHaveChildren}" /> Do you already have children?
                  </div>

                  <!-- Willing to relocate -->
                  <div class="mb-3">
                    <input type="checkbox" th:field="*{WillingToRelocate}"/> Are you willing to relocate for your partner?
                  </div>

                </div>
              </div>
            </div>

          </div>

          <!-- Save Button -->
          <div class="d-grid" style="margin-bottom: 5px;">
            <button type="submit" class="btn btn-primary btn-lg">Save Changes</button>
          </div>

        </form>
    </div>
  </div>
</div>

<footer th:replace="/fragments/footer :: mainFooter"></footer>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('interests-container');
    const selectedInputs = document.getElementById('interests-selected-inputs');

    // Initialize selected set based on hidden inputs
    const selected = new Set();
    selectedInputs.querySelectorAll('input[name="interests"]').forEach(i => selected.add(i.value));

    function updateHiddenInputs() {
      selectedInputs.innerHTML = '';
      selected.forEach(value => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'interests';
        input.value = value;
        selectedInputs.appendChild(input);
      });
    }

    // Pre-select tags
    container.querySelectorAll('.interest-tag').forEach(tag => {
      if (selected.has(tag.dataset.value)) tag.classList.add('selected');
    });

    container.addEventListener('click', e => {
      if (!e.target.classList.contains('interest-tag')) return;
      const value = e.target.dataset.value;
      if (selected.has(value)) {
        selected.delete(value);
        e.target.classList.remove('selected');
      } else {
        selected.add(value);
        e.target.classList.add('selected');
      }
      updateHiddenInputs();
    });
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('languages-container');
    const selectedInputs = document.getElementById('languages-selected-inputs');

    // Initialize selected set based on hidden inputs
    const selected = new Set();
    selectedInputs.querySelectorAll('input[name="languages"]').forEach(i => selected.add(i.value));

    function updateHiddenInputs() {
      selectedInputs.innerHTML = '';
      selected.forEach(value => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'languages';
        input.value = value;
        selectedInputs.appendChild(input);
      });
    }

    // Pre-select tags
    container.querySelectorAll('.language-tag').forEach(tag => {
      if (selected.has(tag.dataset.value)) tag.classList.add('selected');
    });

    container.addEventListener('click', e => {
      if (!e.target.classList.contains('language-tag')) return;
      const value = e.target.dataset.value;
      if (selected.has(value)) {
        selected.delete(value);
        e.target.classList.remove('selected');
      } else {
        selected.add(value);
        e.target.classList.add('selected');
      }
      updateHiddenInputs();
    });
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    let map, marker;

    const mapModal = document.getElementById('mapModal');
    mapModal.addEventListener('shown.bs.modal', () => {
      if (!map) {
        map = L.map('map').setView([20, 0], 2); // Default world view
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
        }).addTo(map);

        map.on('click', function(e) {
          const lat = e.latlng.lat.toFixed(6);
          const lng = e.latlng.lng.toFixed(6);

          // Update marker
          if (marker) marker.remove();
          marker = L.marker([lat, lng]).addTo(map);

          // Update form inputs
          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lng;
        });
      }
      map.invalidateSize(); // Fix map not resizing properly inside modal
    });
  });
</script>
</body>
</html>