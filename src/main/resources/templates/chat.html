<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.5.2/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script src="/utilities.js"></script>
    <style>
        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .mainpanel {
            display: flex;
            height: 92vh;
        }


        #leftpane {
            width: 25%;
            height: 100%;
            background-color: #DDDDDD;
        }
        #chatlist {
            overflow-y: scroll;
            height: 86vh;
        }
        .chat-item {
            border-radius: 10px;
            cursor: pointer;
            margin: 5px 1px 5px 5px;
            transition: transform 0.2s;
        }
        .chat-item:hover {
            transform: scale(1.01);
            background-color: #FFFFFF33;
        }
        .selectedChat {
            background-color: #FFFFFF;
        }
        .selectedChat:hover {
            background-color: #FFFFFF;
        }



        #divider {
            min-width: 4px; cursor: col-resize; background: #AAA;
        }
        #divider:hover {
            background: #888;
        }

        #rightpane {
            width: 100%;
            height: 100%;
        }
        .chat-header {height: 6vh;}
        .chat-header h5 {margin: 0 0 0 10px;}
        #chat-container {
            flex: 1;
            overflow-y: scroll;
            padding: 1rem;
            background-color: #FFFFFF;
            height: 78vh;
            scroll-behavior: smooth;
        }
        #chat-footer {
            height: 8vh; background: #00000011;
        }



        .message {
            max-width: 50%;
            margin-bottom: 5px;
            border-radius: 10px;
            border: 1px solid #00000033;
        }
        .message.self {
            background-color: #BBDDFF;
            margin-left: auto;
            border-top-right-radius: 0;
        }
        .message.other {
            background-color: #FFBBBB;
            margin-right: auto;
            border-top-left-radius: 0;
        }

        .enablemobile {
            display: none;
        }
        .disablemobile {
            display: block;
        }
        .notification-badge {
            background: #ff5454;
            color: white;
            font-size: 12px;
            font-weight: bold;
            border-radius: 50%;
            width: 20px; height: 20px;
            text-align: center;
            justify-content: center;
        }


        .reactions-container {
            position: absolute;
            top: 100%;
            left: 10px;
            margin-top: -8px;
            padding-right: 20px;
            padding-bottom: 5px;
            flex-wrap: wrap;
        }
        .reaction {
            border-radius: 10px;
            border: 1px solid #00000033;
            background-color: #EEEEEEFF;
        }
        .reaction:hover {
            background-color: #DDDDDDFF;
        }


        @media screen and (max-width: 480px) {
            .mainpanel {
                flex-direction: column;
                height: 92vh;
            }
            #leftpane {
                width: 100%;
            }

            #divider {
                display: none;
            }

            #rightpane {
                width: 100%;
            }
            .message {
                max-width: 90%;
            }

            .enablemobile {
                display: block;
            }
            .disablemobile {
                display: none;
            }
        }
    </style>
    <style>
        #typing {
            background-color: #00000011; border-radius: 16px; padding: 10px; margin: 5px; font-size: 16px;
        }
        .dot {
            height: 10px;
            width: 10px;
            margin: 0 2px;
            background-color: #444;
            border-radius: 50%;
            display: inline-block;
            animation: bounce 2.0s infinite;
        }
        .dot:nth-child(1) { animation-delay: 0.2s; }
        .dot:nth-child(2) { animation-delay: 0.4s; }
        .dot:nth-child(3) { animation-delay: 0.6s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
    <style>
        ::-webkit-scrollbar {
            width: 5px;
        }
        ::-webkit-scrollbar-track {
            background: #00000000;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #AAA;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #CCC;
        }
    </style>
    <style>
        .draft-attachment {
            position: relative;
            display: flex;
            width: 11vh;
            height: 11vh;
        }
        .draft-attachment img {
            border-radius: 1vh;
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            border: 1px solid #555;
            background: rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
        }



        .remove-img-button {
            position: absolute;
            bottom: 5px;
            right: 5px;
            border-radius: 50%;
            background-color: #ff0000;
            color: #fff;
            width: 25px;
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
        }
        .remove-img-button:hover {
            background-color: #cc0000;
        }



        .attachment-box {
            display: inline-flex;
            flex-wrap: wrap;
            max-width: 420px;
        }
        .attachment-box.content {
            border-radius: 5px;
        }
        .attachment-box.no-content {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .filebox {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            margin-right: 20px;
            position: relative;
            cursor: pointer;
        }
        .filebox img.image-attachment {
            width: 190px;
            border-radius: 5px;
            transition: transform 0.1s;
        }
        .filebox img.image-attachment:hover {
            transform: scale(1.0075);
        }


        .filebox img.other-attachment {
            width: 60px;
            height: 60px;
            border-radius: 5px 0 0 5px;
            background-color: #FFFE;
        }
        .filebox .details {
            display: block;
            width: 340px;
            height: 60px;
            padding: 5px;
            border-radius: 0 5px 5px 0;
            background-color: #FFFE;
        }
        .filebox .details p {
            margin: 0;
        }


        .filebox video.video-attachment {
            width: 100%;
            border-radius: 5px;
        }

        @media screen and (max-width: 480px) {
            .attachment-box {
                max-width: 300px;
            }

            .filebox img.image-attachment {
                width: 120px;
            }
            .filebox video.video-attachment {
                width: 280px;
                border-radius: 5px;
            }
            .filebox .details {
                width: 220px;
            }
        }
    </style>
    <style>
        #call-box {
            position: absolute;
            width: 100%;
            height: 30vh;
            background: #2f3136;
            color: white;
            padding: 15px;
            display: flex;
            z-index: 100;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .call-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .call-controls, .active-call-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        #remote-videos-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            max-height: 200px;
            overflow-y: auto;
        }

        #remote-videos-container video, #local-video {
            border-radius: 8px;
            object-fit: cover;
            background: #000;
        }

        #local-video-container {
            width: 120px;
            height: 90px;
            border: 2px solid #fff;
            border-radius: 8px;
            overflow: hidden;
            margin: 0 auto;
        }

        .callbtn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .callbtn:hover {
            opacity: 0.85;
        }

        .d-none {
            display: none !important;
        }
    </style>
    <style th:text="'.message.self {background-color: ' + ${Me.Gender == 'Male' ? '#BBDDFF' : (Me.Gender == 'Female' ? '#FFBBBB' : '#EEEE99')} + ';}'"></style>
    <style th:text="'.message.other {background-color: ' + ${Me.Gender == 'Male' ? '#FFBBBB' : (Me.Gender == 'Female' ? '#BBDDFF' : '#EEEE99')} + ';}'"></style>
</head>
<body>
<header th:replace="/fragments/header :: mainHeader"></header>
<div class="mainpanel">
    <div id="leftpane" class="disablemobile">
        <div class="chat-header d-flex align-items-center p-2 border-bottom bg-light">
            <h5><b>Chats</b></h5>
        </div>
        <div id="chatlist">
            <div th:each="chat : ${latestChats}" class="chat-item d-flex align-items-center p-2 border-bottom"
                 th:data-chat-id="${chat.ID}" onclick="selectChat(this)">

                <div class="flex-shrink-0 me-2">
                    <img th:src="${'/file/avatar/' + chat.PartnerUsername + '.png'}" alt="Avatar" class="rounded-circle" width="40" height="40">
                </div>

                <div class="flex-grow-1 w-50">
                    <div class="d-flex align-items-center">
                        <div class="fw-bold" th:text="${chat.PartnerName}">Partner Name</div>
                        <div class="chat-item-date flex-shrink-0 text-muted small ms-auto" th:text="${chat.LatestMessageID != null ? #dates.format(chat.LatestMessageID, 'HH:mm') : ''}">12:30</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="chat-item-content text-muted small text-truncate" th:text="${chat.Content != null ? chat.Content : ''}">Last message content</div>
                        <div class="notification-badge ms-auto" th:style="'display: ' + ${chat.Unreads > 0 ? 'block' : 'none'} + ';'" th:text="${chat.Unreads}">1</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="divider"></div>
    <div id="rightpane">
        <div class="chat-header d-flex align-items-center p-2 border-bottom bg-light">
            <!-- Chat header -->
        </div>
        <div style="position: relative; width: 100%; height: 0">
            <div id="call-box" class="d-none">
                <div class="call-header">
                    <img id="call-avatar" src="/img/default-pfp.png" class="rounded-circle" width="50" height="50">
                    <h5 id="call-username">John Doe</h5>
                </div>

                <!-- Outgoing / Incoming -->
                <div id="call-controls" class="call-controls">
                    <!-- Outgoing -->
                    <button id="cancel-call-btn" class="callbtn btn btn-danger" onclick="cancelCall()">Cancel</button>

                    <!-- Incoming -->
                    <div id="incoming-actions" class="d-none">
                        <button id="accept-call-btn" class="callbtn btn btn-success" onclick="acceptCall()">Accept</button>
                        <button id="decline-call-btn" class="callbtn btn btn-danger" onclick="declineCall()">Decline</button>
                    </div>
                </div>

                <!-- Active Call -->
                <div id="active-call-controls" class="d-none">
                    <div id="remote-videos-container"></div>
                    <div id="local-video-container">
                        <video id="local-video" autoplay muted></video>
                    </div>
                    <div class="active-call-actions">
                        <button onclick="toggleMute()" class="callbtn btn btn-secondary">Mute</button>
                        <button onclick="toggleCamera()" class="callbtn btn btn-secondary">Camera</button>
                        <button onclick="endCall()" class="callbtn btn btn-danger">End Call</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat-container">
            <div id="message-container">
                <!-- Chat messages -->
            </div>
            <div id="typing" style="display:none;">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
            <div id="messageMenu" class="d-none position-absolute bg-white border rounded shadow">
                <button id="copyBtn" class="btn btn-sm w-100">Copy</button>
                <button id="reactBtn" class="btn btn-sm w-100">Add Reaction</button>
                <button id="deleteBtn" class="btn btn-sm w-100">Delete</button>
                <button id="editBtn" class="btn btn-sm w-100 mb-1">Edit</button>
            </div>
            <button id="deleteReaction" class="d-none position-absolute bg-white border rounded shadow">Delete</button>
        </div>

        <div id="chat-footer" class="p-2 border-top">
            <!-- Footer -->
            <div id="draft-attachment-box" class="d-none" style="gap: 5px; height: 12vh;">

            </div>
            <form id="submitMessage" class="d-flex w-100">
                <input type="text" id="draft-message-txtField" name="content" class="form-control" maxlength="1024" placeholder="Type a message...">
                <input type="file" id="draft-file-input" class="d-none" multiple>
                <button type="button" onclick="writeEmoji(this)">üòÄ</button>
                <button type="button" onclick="document.getElementById('draft-file-input').click()">+</button>
                <button type="submit" class="btn btn-primary ms-2">Send</button>
            </form>
        </div>
    </div>
</div>
</body>
<!-- Declarations and Chat selection -->
<script th:inline="javascript">
    const token = /*[[${_csrf.token}]]*/ 0;
    const header = /*[[${_csrf.headerName}]]*/ 0;
    const UserID = /*[[${Me.ID}]]*/ 0;
    let PartnerName = 'NULL';
    let PartnerID = 0;
    let stompClient = Stomp.over(new SockJS('/ws-chat'));
    let currentChatId;

    let leftpane = document.getElementById("leftpane");
    let divider = document.getElementById("divider");
    let rightpane = document.getElementById("rightpane");
    setupDivider(divider, leftpane, rightpane);
    let chatlist = leftpane.querySelector("#chatlist");


    const chatHeader = rightpane.querySelector(".chat-header");
    const chatContainer = rightpane.querySelector('#chat-container');
    const chatFooter = rightpane.querySelector("#chat-footer");

    const messagesContainer = chatContainer.querySelector('#message-container');
    const menu3Dot = chatContainer.querySelector('#messageMenu');
    const deleteReaction = chatContainer.querySelector('#deleteReaction');
    const isTyping = chatContainer.querySelector("#typing");

    const draft_file_input = chatFooter.querySelector("#draft-file-input");
    const draft_attachment_box = chatFooter.querySelector("#draft-attachment-box");
    const draft_message_txtField = chatFooter.querySelector('#draft-message-txtField');



    // Select a chat.
    function selectChat(selectedChatItem) {
        if (!selectedChatItem) return;
        const chatId = selectedChatItem.dataset.chatId;
        if (chatId === currentChatId) return;
        fetch(`/chat/user/${chatId}`)
            .then(res => res.json())
            .then(data => {
                const { messages, partner, draft } = data;
                selectedChatItem.querySelector('.notification-badge').style.display = 'none';
                chatlist.querySelectorAll('.chat-item').forEach(item => item.classList.remove('selectedChat'));
                selectedChatItem.classList.add('selectedChat');
                PartnerName = partner.Name;
                PartnerID = partner.ID;
                currentChatId = chatId;

                leftpane.classList.add('disablemobile');
                rightpane.classList.remove('disablemobile');

                loadDraftMessage(draft ? draft.Content : '')
                loadDraftAttachments(draft ? draft.attachments : null);

                loadMessages(messages)

                chatHeader.innerHTML = `
                  <button class="enablemobile btn btn-sm text-muted" onclick="exitChat()"><h1 style="margin: 0">‚Üê</h1></button>
                  <a href="/profile/${partner.Username}">
                    <img src="/file/avatar/${partner.Username}.png" alt="Profile Pic" class="rounded-circle me-2" width="30" height="30">
                  </a>
                  <a href="/profile/${partner.Username}" class="fw-bold text-dark text-decoration-none">
                     ${PartnerName}
                  </a>
                `;
                //<div class="ms-auto">
                //     <button onclick="startCall(PartnerName, null)" id="start-call-btn" class="btn btn-sm btn-outline-primary">Call</button>
                //</div>
            });

    }
    function exitChat() {
        leftpane.classList.remove('disablemobile');
        rightpane.classList.add('disablemobile');
    }
    // Load first chat.
    selectChat(document.querySelector('.chat-item'));
</script>

<!-- Signal receivers and handlers -->
<script>
    stompClient.connect({}, function(frame) {
        console.log('Connected: ' + frame);

        // Receives a typing animation from the server.
        stompClient.subscribe('/user/queue/typing', function(chatObject) {
            if (currentChatId !== chatObject.body) return;
            isTyping.style.display = "inline-block";
            if (isNearBottom(chatContainer, 80)) chatContainer.scrollTop = chatContainer.scrollHeight;
            setTimeout(() => {
                isTyping.style.display = "none";
            }, 5000);
        });

        // Receives a message from the server
        stompClient.subscribe('/user/queue/message/receive', function(messageOutput) {
            isTyping.style.display = "none";
            renderMessage(JSON.parse(messageOutput.body), UserID);
        });

        // Receives a message update from the server
        stompClient.subscribe('/user/queue/message/update', function(messageOutput) {
            const msg = JSON.parse(messageOutput.body);
            const p = messagesContainer.querySelector(`[data-message-id='${msg.ID}'] p`);
            if (!p) return;
            p.textContent = msg.Content;
            if (msg.isEdited) {
                let editedSpan = document.createElement('span');
                editedSpan.classList.add('text-muted', 'ms-1');
                editedSpan.style.fontSize = '0.8em';
                editedSpan.textContent = '(edited)';
                p.appendChild(editedSpan);
            }
        });

        // Receives a message delete from the server
        stompClient.subscribe('/user/queue/message/delete', function(messageOutput) {
            const messageId = JSON.parse(messageOutput.body);
            const msgDiv = messagesContainer.querySelector(`[data-message-id='${messageId}']`);
            if (msgDiv) msgDiv.remove();
        });


        // Receives a message reaction from the server
        stompClient.subscribe('/user/queue/reaction/refresh', function(messageOutput) {
            const message = JSON.parse(messageOutput.body);
            const reactionContainer = messagesContainer.querySelector('#reactions-' + message.MessageID);
            const msgDiv = messagesContainer.querySelector(`[data-message-id='${message.MessageID}']`);
            renderReactions(msgDiv, reactionContainer, message.reactions);
        });


        // Receives a message notification from the server
        stompClient.subscribe('/user/queue/notification/receive', function(chatOutput) {
            const chat = JSON.parse(chatOutput.body);
            const chatItem = document.querySelector(`[data-chat-id="${chat.ID}"]`);
            addNotification(chat, chatItem);
            moveElementToTop(chatlist, chatItem);
        });

        // Receives a message notification from the server
        stompClient.subscribe('/user/queue/notification/update', function(chatOutput) {
            const chat = JSON.parse(chatOutput.body);
            const chatItem = document.querySelector(`[data-chat-id="${chat.ID}"]`);
            addNotification(chat, chatItem);
        });


        // Receives an attachment delete from the server.
        stompClient.subscribe('/user/queue/attachment/delete', function(attachmentObj) {
            const attachment = JSON.parse(attachmentObj.body);
            let attachmentBox = messagesContainer.querySelector(`[data-attachment-box-message-id="${attachment.MessageID}"]`);
            attachmentBox.querySelector(`[data-attachment-id="${attachment.ID}"]`).remove();
            if (attachmentBox.children.length === 0) attachmentBox.remove()
        });

    });
</script>

<!-- Message sending handlers -->
<script>
    // Send typing and creates draft
    draft_message_txtField.addEventListener("input", (event) => {
        stompClient.send("/app/typing", {}, JSON.stringify({
            ChatID: currentChatId,
            Content: draft_message_txtField.value
        }));
    });
    // Upload files and updates draft
    draft_file_input.addEventListener("change", (event) => {
        uploadFiles(draft_file_input.files);
    });
    // Paste images and updates draft
    draft_message_txtField.addEventListener("paste", (e) => {
        if (document.activeElement !== draft_message_txtField) return;
        const items = e.clipboardData.items;
        const files = [];
        for (let i = 0; i < items.length; i++) {
            if (items[i].kind !== "file") continue;
            const file = items[i].getAsFile();
            if (file) files.push(file);
        }
        if (files.length > 0) uploadFiles(files);
    });
    // Drag and drop files and updates draft
    messagesContainer.addEventListener("dragover", (e) => e.preventDefault());
    messagesContainer.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadFiles(e.dataTransfer.files);
    });
    messagesContainer.addEventListener("click", (e) => {
        e.preventDefault();
        menu3Dot.classList.add('d-none');
        deleteReaction.classList.add('d-none');
    });
    function uploadFiles(files) {
        if (files.length === 0) return;
        const formData = new FormData();
        formData.append("chatId", currentChatId);
        for (let i = 0; i < files.length; i++) formData.append("attachments", files[i]);
        fetch("/chat/draft/attachment/upload", {
            method: "POST",
            body: formData,
            headers: {
                [header]: token
            }
        }).then(res => res.json()).then(attachments => {loadDraftAttachments(attachments);});
    }
    function writeEmoji(el) {
        window.picker.togglePicker(el);
        window.isWritingEmoji = true;
    }

    // Send the message (transform draft to message)
    document.getElementById('submitMessage').addEventListener('submit', function(e) {
        e.preventDefault();
        if (draft_message_txtField.value.length === 0 && draft_attachment_box.children.length === 0) return;
        stompClient.send("/app/message/send", {}, JSON.stringify({
            ChatID: currentChatId,
            Content: draft_message_txtField.value
        }));
        loadDraftMessage('');
        loadDraftAttachments([]);
    });

    // Edit the message
    function editMessage(msg) {
        let newContent = prompt("Edit your message:", msg.Content);
        if (!newContent) return;
        stompClient.send("/app/message/edit", {}, JSON.stringify({
            ID: msg.ID,
            Content: newContent
        }));
    }
    // Deleting the message
    function deleteMessage(msg) {
        if (!confirm("Delete this message?")) return;
        stompClient.send("/app/message/delete", {}, JSON.stringify(msg.ID));
    }
</script>

<!-- Loaders -->
<script>
    function loadDraftMessage(content) {
        draft_message_txtField.value = content;
    }
    function loadDraftAttachments(attachments) {
        draft_attachment_box.innerHTML = '';
        if (attachments && attachments.length > 0) {
            chatFooter.style.height = "20vh";
            chatContainer.style.height = "66vh";
            draft_attachment_box.classList.remove("d-none");
            attachments.forEach(att => {
                let div = document.createElement("div");
                div.classList.add("draft-attachment");
                let img = document.createElement("img");
                div.append(img);
                if (att.FileType.startsWith("image/")) {
                    img.src = `/file/draft/attachment/${att.ID}`;
                    img.onclick = () => {
                        window.open(`/file/draft/attachment/${att.ID}`, '_blank');
                    }
                } else {
                    img.src = `/img/file.png`;

                    let details = document.createElement('div');
                    details.classList.add('align-items-center')
                    details.style.display = 'block';
                    details.style.borderRadius = '0 5px 5px 0';
                    details.style.backgroundColor = '#FFFE';
                    details.style.margin = '5px 0';
                    details.style.padding = '5px';
                    details.innerHTML = `<h5 style="text-wrap: nowrap;">` + att.FileName + `</h5><p>` + formatFileSize(att.FileData) + `</p>`;
                    div.appendChild(details);
                }

                let deletebtn = document.createElement("div");
                deletebtn.classList.add("remove-img-button");
                deletebtn.textContent = "X";
                div.appendChild(deletebtn);
                deletebtn.onclick = () => {
                    const formData = new FormData();
                    formData.append("attachmentId", att.ID);
                    fetch(`/chat/draft/attachment/delete`, {
                        method: "DELETE",
                        body: formData,
                        headers: {
                            [header]: token
                        }
                    }).then(res => res.json())
                        .then(data => {
                            div.remove();
                            if (draft_attachment_box.children.length === 0) {
                                chatFooter.style.height = "8vh";
                                chatContainer.style.height = "78vh";
                                draft_attachment_box.classList.add("d-none");
                            }
                        })
                }
                draft_attachment_box.appendChild(div);
            })
        } else {
            chatFooter.style.height = "8vh";
            chatContainer.style.height = "78vh";
            draft_attachment_box.classList.add("d-none");
        }
    }

    function loadMessages(msgs) {
        if (msgs && msgs.length > 0) {
            messagesContainer.innerHTML = '';
            msgs.forEach(msg => renderMessage(msg));
        } else {
            messagesContainer.innerHTML =
                `<div class="text-center">This is the start of your conversation with <b>${PartnerName}</b>, remember to
                 <br>always be respectful no matter the person.
                 </div>`;
        }
    }
    function renderMessage(msg) {
        // main box
        let messageBox = document.createElement('div');
        messageBox.classList.add('message');
        messageBox.dataset.messageId = msg.ID;
        messageBox.classList.add(msg.UserID === UserID ? 'self' : 'other');
        messageBox.style.width = 'fit-content';


        // Box
        let cardBody = document.createElement('div');
        cardBody.classList.add('card-body', 'position-relative', 'p-2', 'd-flex');
        cardBody.style.paddingRight = '5px';
        cardBody.style.flexDirection = 'column';

        // Attachments
        if (msg.attachments && msg.attachments.length > 0) cardBody.appendChild(renderMessageAttachments(msg));

        // Content
        let content = document.createElement('p');
        content.classList.add('mb-0');
        content.style.marginRight = '20px';
        content.style.textWrap = 'wrap';
        content.style.wordBreak = 'break-word';
        content.textContent = msg.Content;
        if (msg.isEdited) {
            let editedSpan = document.createElement('span');
            editedSpan.classList.add('text-muted', 'ms-1');
            editedSpan.style.fontSize = '0.75em';
            editedSpan.textContent = '(edited)';
            content.appendChild(editedSpan);
        }
        cardBody.appendChild(content);

        // 3 Dot
        const dot3 = renderMessage3Dot(msg, content);
        cardBody.appendChild(dot3);
        cardBody.oncontextmenu = dot3.onclick;



        const reactionsContainer = document.createElement('div');
        reactionsContainer.classList.add('reactions-container', 'd-flex', 'gap-1');
        reactionsContainer.id = `reactions-${msg.ID}`;
        if (msg.reactions && msg.reactions.length > 0) {
            renderReactions(messageBox, reactionsContainer, msg.reactions);
        }
        cardBody.appendChild(reactionsContainer);

        // Timestamp
        let small = document.createElement('small');
        small.classList.add('text-muted');
        small.style.fontSize = '0.75em';
        small.style.marginLeft = 'auto';
        small.textContent = formatChatDate(msg.ID);
        cardBody.appendChild(small);


        let card = document.createElement('div');
        card.appendChild(cardBody);

        messageBox.appendChild(card);
        messagesContainer.appendChild(messageBox);
        if (isNearBottom(chatContainer)) chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    function renderMessageAttachments(msg) {
        let attachmentBox = document.createElement('div');
        attachmentBox.dataset.attachmentBoxMessageId = msg.ID;
        attachmentBox.classList.add('attachment-box');
        attachmentBox.classList.add(msg.Content.length > 0 ? 'content' : 'no-content');

        for (let i = 0; i < msg.attachments.length; i++) {
            let att = msg.attachments[i];
            let filebox = document.createElement('div');
            filebox.classList.add('filebox');
            filebox.dataset.attachmentId = att.ID;

            if (att.FileType.startsWith("image/")) {
                let img = document.createElement('img');
                img.src = `/file/message/attachment/${att.ID}`;
                img.classList.add('image-attachment');
                img.onclick = () => window.open(`/file/message/attachment/${att.ID}`, '_blank');

                filebox.appendChild(img);
            } else if (att.FileType.startsWith("video/")) {
                let video = document.createElement('video');
                video.src = `/file/message/attachment/${att.ID}`;
                video.controls = true;
                video.classList.add('video-attachment');

                filebox.appendChild(video);

            } else {
                let img = document.createElement('img');
                img.src = `/img/file.png`;
                img.classList.add('other-attachment');

                let details = document.createElement('div');
                details.classList.add('details');
                details.innerHTML = `
                   <p>${att.FileName}</p>
                   <p>${formatFileSize(att.FileData)}</p>
                `;
                details.onclick = () => window.open(`/file/message/attachment/${att.ID}`, '_blank');

                filebox.appendChild(img);
                filebox.appendChild(details);
            }

            // Delete button code remains the same
            let deletebtn = document.createElement("div");
            deletebtn.classList.add("remove-img-button");
            deletebtn.style.display = "none";
            deletebtn.textContent = "X";
            deletebtn.onclick = () => {
                if (!confirm("Delete this attachment?")) return;
                stompClient.send("/app/message/attachment/delete", {}, JSON.stringify(att.ID));
            }
            filebox.appendChild(deletebtn);

            filebox.onmouseover = () => { deletebtn.style.display = "flex"; }
            filebox.onmouseout = () => { deletebtn.style.display = "none"; }

            attachmentBox.appendChild(filebox);
        }
        return attachmentBox;
    }
    function renderMessage3Dot(msg, content) {
        let menuBtn = document.createElement('button');
        menuBtn.classList.add('btn', 'btn-sm', 'position-absolute');
        menuBtn.style.top = '5px';
        menuBtn.style.right = '5px';
        menuBtn.textContent = '‚ãÆ';

        menuBtn.onclick = (event) => {
            event.stopPropagation();
            event.preventDefault();
            // Set the menu position to where the button is clicked
            menu3Dot.style.top = `${event.pageY - 100}px`;
            menu3Dot.style.left = `${event.pageX - 240}px`;
            menu3Dot.classList.remove('d-none');
            // Attach actions dynamically
            if (msg.UserID === UserID) {
                document.getElementById('editBtn').classList.remove('d-none');
                document.getElementById('deleteBtn').classList.remove('d-none');
            } else {
                document.getElementById('editBtn').classList.add('d-none');
                document.getElementById('deleteBtn').classList.add('d-none');
            }
            document.getElementById('editBtn').onclick = () => {
                editMessage(msg);
                menu3Dot.classList.add('d-none');
            };
            document.getElementById('deleteBtn').onclick = () => {
                deleteMessage(msg);
                menu3Dot.classList.add('d-none');
            };
            document.getElementById('copyBtn').onclick = () => {
                navigator.clipboard.writeText(content.textContent);
                menu3Dot.classList.add('d-none');
            };
            document.getElementById('reactBtn').onclick = () => {
                menu3Dot.classList.add('d-none');
                window.ReactionMessageID = msg.ID;
                window.picker.togglePicker(event.target);
            };
        };
        return menuBtn;
    }
    function renderReactions(messageBox, reactionContainer, reactions) {
        reactionContainer.innerHTML = '';
        for (let i = 0; i < reactions.length; i++) {
            let reactItem = document.createElement('button');
            reactItem.classList.add('reaction');
            reactItem.dataset.reactionId = reactions[i].MessageID + '-' + reactions[i].Emoji;
            reactItem.textContent = reactions[i].Emoji + reactions[i].Count;
            reactItem.onclick = (event) => {
                event.stopPropagation();
                event.preventDefault();
                deleteReaction.classList.remove('d-none');
                deleteReaction.style.top = `${event.pageY - 30}px`;
                deleteReaction.style.left = `${event.pageX - 60}px`;
                deleteReaction.onclick = () => {
                    deleteReaction.classList.add('d-none');
                    stompClient.send("/app/reaction/delete", {}, JSON.stringify({
                        MessageID: reactions[i].MessageID,
                        Emoji: reactions[i].Emoji
                    }))
                }
            }
            reactionContainer.appendChild(reactItem);
        }
        if (messageBox) {
            if (window.innerWidth <= 420) messageBox.style.minWidth = Math.min(27.5 + (reactions.length * 17.5), 90) + '%';
            else if (window.innerWidth > 420) messageBox.style.minWidth = Math.min(15 + (reactions.length * 7.5), 50) + '%';
            setTimeout(() => {
                messageBox.style.marginBottom = (reactionContainer.offsetHeight-5) + "px";
            }, 0);
        }
    }

    function addNotification(chat, chatItem) {
        chatItem.querySelector('.chat-item-date').textContent = new Date(chat.LatestMessageID).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        chatItem.querySelector('.chat-item-content').textContent = chat.Content;
        if (chat.Unreads > 0 && chat.ID !== currentChatId) {
            let badge = chatItem.querySelector('.notification-badge');
            badge.textContent = chat.Unreads;
            badge.style.display = 'block';
        }
    }
</script>
<script type="module">
    import { EmojiButton } from 'https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.0/dist/index.min.js';
    window.picker = new EmojiButton({
        search: true,
        showPreview: true,
        autoHide: true
    });
    window.picker.on('emoji', emoji => {
        if (window.isWritingEmoji) {
            draft_message_txtField.value += emoji.emoji;
            window.isWritingEmoji = false;
        } else if (window.ReactionMessageID) {
            stompClient.send("/app/reaction/send", {}, JSON.stringify({
                MessageID: window.ReactionMessageID,
                Emoji: emoji.emoji
            }));
        }
    });
</script>
<script>
    // Outgoing call logic
    function startCall(user, avatarUrl) {
        document.getElementById('call-box').classList.remove('d-none');
        document.getElementById('call-username').innerText = `Calling ${user}...`;
        document.getElementById('call-avatar').src = avatarUrl || '/img/default-pfp.png';

        document.getElementById('call-controls').classList.remove('d-none');
        document.getElementById('incoming-actions').classList.add('d-none');
        document.getElementById('active-call-controls').classList.add('d-none');
    }

    // Cancel outgoing call
    function cancelCall() {
        console.log('Call canceled');
        document.getElementById('call-box').classList.add('d-none');
        // Add your original cancel logic here (e.g., stop signaling)
    }

    // Incoming call popup
    function incomingCall(user, avatarUrl) {
        document.getElementById('call-box').classList.remove('d-none');
        document.getElementById('call-username').innerText = user;
        document.getElementById('call-avatar').src = avatarUrl || '/img/default-pfp.png';

        document.getElementById('call-controls').classList.add('d-none');
        document.getElementById('incoming-actions').classList.remove('d-none');
        document.getElementById('active-call-controls').classList.add('d-none');
    }

    // Accept incoming call
    function acceptCall() {
        console.log('Call accepted');
        document.getElementById('call-controls').classList.add('d-none');
        document.getElementById('incoming-actions').classList.add('d-none');
        document.getElementById('active-call-controls').classList.remove('d-none');

        // Add your original accept logic here (e.g., start WebRTC)
    }

    // Decline incoming call
    function declineCall() {
        console.log('Call declined');
        document.getElementById('call-box').classList.add('d-none');
        // Add your original decline logic here
    }

    // Active call
    function endCall() {
        console.log('Call ended');
        document.getElementById('call-box').classList.add('d-none');
        // Add your original end call logic here
    }

    // Toggle functions
    function toggleMute() {
        console.log('Toggle mute');
        // Your original toggleMute logic
    }

    function toggleCamera() {
        console.log('Toggle camera');
        // Your original toggleCamera logic
    }
</script>
</html>